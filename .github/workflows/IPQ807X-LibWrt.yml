name: Build Redmi AX6

on:
  workflow_dispatch:
  # 如果你想每周五早上4点自动编译，取消下面两行的注释
  # schedule:
  #   - cron: 0 20 * * 5

env:
  REPO_URL: https://github.com/laipeng668/openwrt-6.x.git
  REPO_BRANCH: main-nss
  # 注意：这里直接指向你仓库根目录的 .config
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: Redmi-AX6-Pure
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2004-make-openwrt-depends)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone Source Code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load Custom Configuration
      run: |
        [ -e $DIY_P1_SH ] && chmod +x $DIY_P1_SH && cd openwrt && $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config Settings
      run: |
        [ -e $DIY_P2_SH ] && chmod +x $DIY_P2_SH && cd openwrt && $GITHUB_WORKSPACE/$DIY_P2_SH
        # 关键修改：直接复制你的配置文件到 openwrt 目录
        cp $GITHUB_WORKSPACE/$CONFIG_FILE $GITHUB_WORKSPACE/openwrt/.config

    - name: Download Package
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      with:
        tag_name: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
        files: ${{ env.FIRMWARE }}/*
        body: |
          Redmi AX6 纯净版主路由固件
          源码: LiBwrt / main-nss
          包含: OpenClash, UPnP, NSS加速
          默认地址: 192.168.10.1 (或源码默认值)
          密码: password (或 none)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
